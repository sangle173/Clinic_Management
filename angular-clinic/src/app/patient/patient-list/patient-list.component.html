<div class="container-fluid" style="width: 80%">
  <table id="example" class="table table-striped table-hover mt-5">
    <thead>
    <tr>
      <td colspan="7" class="bg-dark text-white text-center">
        <h3>Quản Lý Bệnh Nhân</h3>
      </td>
    </tr>
    <tr>
      <td colspan="4">
        <input class="form-control mb-2" type="search" #searchKeyword
               (change)="getAllPatients(searchKeyword.value)" placeholder="Tìm kiếm..." aria-label="Search">
      </td>
      <td colspan="3" class="text-center">
        <button data-toggle="modal" data-target=".bd-example-modal-lg" class="btn btn-primary"><i class="fa fa-plus"
                                                                                                  aria-hidden="true"></i>
          Thêm Mới
        </button>
      </td>
    </tr>
    <tr>
      <th>#</th>
      <th>Họ Tên</th>
      <th>Số Điện Thoại</th>
      <th>Địa Chỉ</th>
      <th>Năm Sinh</th>
      <th>Giới Tính</th>
      <th>Khác</th>
    </tr>
    </thead>
    <ng-container *ngIf="messageError != ''; else elseBlock">
      <tbody>
      <tr>
        <td colspan="7" class="text-center">
          <span class="text-danger">{{messageError}}</span>
        </td>
      </tr>
      </tbody>
    </ng-container>
    <ng-template #elseBlock>
      <tbody>
      <tr *ngFor="let patient of patients | slice: (page-1) * pageSize : page * pageSize;index as i">
        <td style="width: 5%">{{i + 1}}</td>
        <td>{{patient.name}}</td>
        <td>{{patient.phoneNumber}}</td>
        <td>{{patient.address}}</td>
        <td>{{patient.yearOfBirth}}</td>
        <td>{{patient.gender}}</td>
        <td>
          <a href="" (click)="sendIdToComponent(patient.id)" class="mr-2" data-toggle="modal"
             data-target=".bd-example-modal-xl">
            <i class="fa fa-arrow-right text-secondary" style="font-size: 1.5rem"
               aria-hidden="true"></i></a>
          <a [routerLink]="['/patients/view',patient.id]" class="mr-2">
            <i class="fa fa-eye text-success" style="font-size: 1.5rem" aria-hidden="true"></i>
          </a>
          <a href="" class="text-danger" data-toggle="modal" data-target="#exampleModal"
             (click)="sendIdToComponent(patient.id)">
            <i class="fa fa-trash-o text-danger" style="font-size: 1.5rem" aria-hidden="true"></i></a>
        </td>
      </tr>
      </tbody>
    </ng-template>
  </table>
  <div class="clearfix">
    <div class="hint-text">Hiển thị <b>{{pageSize}}</b> trên <b>{{collectionSize}}</b> Bệnh Lý</div>
    <ngb-pagination class="d-flex justify-content-end"
                    [(page)]="page"
                    [pageSize]="pageSize"
                    [collectionSize]="collectionSize"
                    [maxSize]="5"
                    [rotate]="true"
                    [ellipses]="true"
                    [boundaryLinks]="true">
      <ng-template ngbPaginationFirst>Trang đầu</ng-template>
      <ng-template ngbPaginationLast>Trang cuối</ng-template>
      <ng-template ngbPaginationEllipsis>...</ng-template>
      <ng-template ngbPaginationNumber let-page>{{ page }}</ng-template>
    </ngb-pagination>
    <hr>
  </div>
</div>

<!--add new modal-->
<div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="myExtraLargeModalLabel">Thêm Mới Bệnh Nhân</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="createForm" (ngSubmit)="submit()">
          <div class="form-row">
            <div class="col-6">
              <div class="form-group">
                <label for="name" class="col-form-label">Tên Bệnh Nhân: <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="name" id="name">
              </div>
            </div>
            <div class="col-6">
              <div class="form-group">
                <label for="gender" class="col-form-label">Giới tính:</label>
                <select name="category" class="form-control" id="gender" formControlName="gender">
                  <option value="Nam" selected>Nam</option>
                  <option value="Nữ">Nữ</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="col-6">
              <div class="form-group">
                <label for="phoneNumber" class="col-form-label">Điện Thoại:</label>
                <input type="text" class="form-control" formControlName="phoneNumber" id="phoneNumber">
              </div>
            </div>
            <div class="col-6">
              <div class="form-group">
                <label for="yearOfBirth" class="col-form-label">Năm Sinh:</label>
                <input type="text" class="form-control" formControlName="yearOfBirth" id="yearOfBirth">
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="col-6">
              <div class="form-group">
                <label for="height" class="col-form-label">Chiều Cao:</label>
                <input type="number" class="form-control" formControlName="height" id="height">
              </div>
            </div>
            <div class="col-6">
              <div class="form-group">
                <label for="weight" class="col-form-label">Cân Nặng:</label>
                <input type="number" class="form-control" formControlName="weight" id="weight">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="address" class="col-form-label">Địa Chỉ:</label>
            <select name="address" class="form-control" id="address" formControlName="address">
              <option disabled value="" selected>Chọn địa chỉ</option>
              <option *ngFor="let address of addressList"
                      [ngValue]="address">{{address}}</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
            <button type="submit" id="btnSave" class="btn btn-primary">Tạo Bệnh
              Nhân
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!--add history modal-->
<div class="modal fade bd-example-modal-xl" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="addHistoryModal">Thêm Mới Lịch Sử Khám Bệnh</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ngb-accordion #acc="ngbAccordion" activeIds="ngb-panel-1">
          <ngb-panel>
            <ng-template ngbPanelTitle>
              <span>&#9733; <b>Thông tin bệnh Nhân</b></span>
            </ng-template>
            <ng-template ngbPanelContent>
              <table class="table table-striped ">
                <tr class="text-dark font-weight-bold">
                  <td  style="width: 20%">Họ Tên:</td>
                  <td>{{namePatientChoosing}}</td>
                  <td style="width: 20%">Điện Thoại:</td>
                  <td>{{phoneNumberPatientChoosing}}</td>
                  <td></td>
                </tr>
                <tr class="text-dark font-weight-bold">
                  <td>Giới Tính:</td>
                  <td>{{genderPatientChoosing}}</td>
                  <td>Năm Sinh:</td>
                  <td>{{yearOfBirthPatientChoosing}}</td>
                  <td></td>
                </tr>
                <tr class="text-dark font-weight-bold">
                  <td>Chiều Cao:</td>
                  <td>{{heightPatientChoosing}}cm</td>
                  <td>Cân Nặng:</td>
                  <td>{{weightPatientChoosing}}kg</td>
                  <td></td>
                </tr>
                <tr class="text-dark font-weight-bold">
                  <td>Địa Chỉ:</td>
                  <td>{{addressPatientChoosing}}</td>
                  <td>Ngày Tạo:</td>
                  <td>{{dateCreatedPatientChoosing | date: 'dd/MM/yyyy'}}</td>
                  <td></td>
                </tr>
                <tr class="bg-dark">
                  <td colspan="5" class="text-center font-weight-bold text-white">
                    Thông tin lần khám gần nhất
                  </td>
                </tr>
                <tr>
                  <th style="width: 10%;">Ngày khám</th>
                  <th  style="width: 30%;">Bệnh lý</th>
                  <th  style="width: 30%;">Đơn thuốc</th>
                  <th  style="width: 20%;">Ghi chú</th>
                  <th  style="width: 10%;">Tiền khám</th>
                </tr>
                <tr>
                  <td class="font-weight-bold text-primary">{{nearlyHistory.dateCreated | date: "dd/MM/yyyy"}}</td>
                  <td>
          <span class="font-weight-bold text-danger" *ngFor="let path of nearlyHistory.pathologicals">
            <span>&#9758; {{path['pathologicalName']}}</span> <br>
          </span>
                  </td>
                  <td>
          <span *ngFor="let medicine of nearlyHistory.medicines">
            <span class="font-weight-bold text-success">&#9957; {{medicine['medicineName']}}</span> <br>
          </span>
                  </td>
                  <td class="font-weight-bold text-secondary">{{nearlyHistory.note}}</td>
                  <td class="font-weight-bold text-primary">{{nearlyHistory.unitPrice | number: "1.0-0"}}đ</td>
                </tr>
              </table>
            </ng-template>
          </ngb-panel>
        </ngb-accordion>
        <ngb-accordion #acc="ngbAccordion" activeIds="ngb-panel-1">
          <ngb-panel>
            <ng-template ngbPanelTitle>
              <span>&#9733; <b>Thêm lịch sử khám</b></span>
            </ng-template>
            <ng-template ngbPanelContent>
              <form [formGroup]="createHistoryFrom" (ngSubmit)="onSubmit()">
                <input type="hidden" class="form-control" formControlName="patientId" [(ngModel)]="idPatientChoosing">
                <div class="form-row mt-2">
                  <div class="col-6">
                    <label class="font-weight-bold mr-2">Bệnh lý:</label>
                    <button class="btn btn-mute" type="button" (click)="addPathological()"><i class="fa fa-plus text-danger" aria-hidden="true"></i></button>
                  </div>
                  <div class="col-6">
                    <label class="font-weight-bold mr-2">Đơn thuốc:</label>
                    <button class="btn btn-mute" type="button" (click)="addMedicineArray()"><i class="fa fa-plus text-danger" aria-hidden="true"></i></button>
                  </div>
                </div>

                <div class="form-row mt-2">
                  <div class="col-6">
                    <div formArrayName="pathologicals">
                      <div *ngFor="let path of pathologicals.controls; let i=index">
                        <table [formGroupName]="i" class="table table-borderless">
                          <tr>
                            <td>
                              <span class="font-weight-bold">Bệnh lý {{i + 1}}:</span>
                            </td>
                            <td>
                              <select class="form-control" formControlName="idPathological">
                                <option value="" disabled>Chọn bệnh</option>
                                <option [ngValue]="e.id" *ngFor="let e of pathologicalList">
                                  {{e.pathologicalName}}
                                </option>
                              </select>
                            </td>
                            <td>
                              <button class="btn" (click)="removePathological(i)"><i class="fa fa-times text-danger"
                                                                                     aria-hidden="true"></i></button>
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div formArrayName="medicineArray">
                      <div *ngFor="let medicine of medicineArray.controls; let i=index">
                        <table [formGroupName]="i" class="table table-borderless">
                          <tr>
                            <td>
                              <span class="font-weight-bold">Thuốc {{i + 1}}:</span>
                            </td>
                            <td>
                              <select class="form-control" formControlName="idMedicine">
                                <option value="" disabled>Chọn thuốc</option>
                                <option [ngValue]="e.id" *ngFor="let e of medicines">
                                  {{e.medicineName}}
                                </option>
                              </select>
                            </td>
                            <td>
                              <button class="btn" (click)="removeMedicineArray(i)"><i class="fa fa-times text-danger"
                                                                                      aria-hidden="true"></i></button>
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-row mt-2">
                  <div class="col-6">
                    <div class="form-group">
                      <label class="font-weight-bold" for="note">Ghi chú:</label>
                      <textarea class="form-control" id="note" formControlName="note" placeholder="Thêm ghi chú..." rows="1"></textarea>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-group">
                      <label class="font-weight-bold" for="price">Tiền khám:</label>
                      <input type="text" class="form-control" id="price" placeholder="Nhập tiền khám..." formControlName="unitPrice">
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                  <button type="submit" class="btn btn-primary">Tạo Mới
                  </button>
                </div>
              </form>
            </ng-template>
          </ngb-panel>
        </ngb-accordion>


      </div>
    </div>
  </div>
</div>

<!--delete modal-->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h4 class="modal-title w-100 text-center text-white" id="exampleModalLabel">Xóa Bệnh Nhân </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa <span
          style
            ="color: red">{{patientDelete}}</span>?</p>
      </div>
      <div
        class
          ="modal-footer">
        <button
          type
            ="button" class="btn btn-secondary" data-dismiss="modal">Hủy bỏ
        </button>
        <button type="button" class="btn btn-danger" (click)="deletePatient()" data-dismiss="modal">
          Xóa
        </button>
      </div>
    </div>
  </div>
</div>
<ngx-bootstrap-spinner
  bdColor="rgba(51,51,51,0.8)"
  size="default"
  color="#fff"
  type="border"
  loadingText="Đang tải dữ liệu..."
>
</ngx-bootstrap-spinner>

